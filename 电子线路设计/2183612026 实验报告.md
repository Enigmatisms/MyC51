





![](C:\Users\15300\Desktop\数电实验\电子线路设计\图片1.png)





<center><font size=7 face="微软雅黑"><b> 电 子 线 路 设 计 实 验 报 告 </font></center></centerb>

---

<center> 自动化84 何千越 2183612026 </center>

<center> 2020.10.25 </center>



<div style="page-break-after: always;"></div>

<font size=6 face="微软雅黑"><b>目录</b>(点击导航)</font>

---

[toc]

<div style="page-break-after: always;"></div>

---

## I. 设计一 模拟微信

---

#### 一、组合功能介绍

##### 1.1.0 框架与流程图

![](C:\Users\15300\Desktop\数电实验\电子线路设计\sim.png)

<center>模块框架图</center>

![](C:\Users\15300\Desktop\数电实验\电子线路设计\power.png)

<center>流程示意图</center>

##### 1.1.1 密码解锁

| <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\pass.JPG" style="zoom:50%;" /> | <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\pass2.JPG" style="zoom:50%;" /> |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                         提示输入密码                         |                         密码输入错误                         |

​		上电开机时，需要输入密码才能进入“模拟微信”主程序。密码默认为 123456789，使用软件进行设置，内部没有修改密码的程序（因为本身不属于“模拟微信”的重点）。输入错误显示：Incorrect Input，并清空输入区。输入区中，只有<u>**输入的最后一位**</u>会被显示，其余均被显示成"*"。密码输入支持0~9十位数字 + 26个字母大小写组合，以及4个符号“，.  !  ?”以及空格。

​		三次输入密码将导致程序锁死，有关提示音的内容，请看点击->[【蜂鸣器】](#wechatBuzzer). 输入正确则可进入主程序。

##### 1.1.2 串口消息收发

​		本功能是“模拟微信”的主要功能

<img src="C:\Users\15300\Desktop\数电实验\电子线路设计\wechat.JPG" style="zoom:50%;" />

​		为了尽可能“模拟微信”，之前的密码输入环节模拟的是手机的锁屏界面，而打开锁屏之后直接进入聊天框。我方（主机）发送消息时，最下方一行为我方的输入框（就像手机的聊天输入框）。而我方发送的消息会显示在靠右的位置，对方（从机）发送的消息会显示在靠左的位置，并且对方在发送消息时，消息不会显示在输入框上（就像正常聊天时，我们只能看到对方发送了什么，看不到对方正在输入什么）。并且，消息存在滚动刷新方式。当存在新消息时，历史消息会向上滚动。这都尽可能模拟了实际聊天时的情况。

​		顶部栏显示的则是“微信”软件的版本号。消息的发送使用的是单片机之间的串口通信。

##### 1.1.3 矩阵键盘响应

​		有关矩阵键盘的硬件原理图，可以查看：

- 附录 设计一 原理图

- 设计一的硬件实现部分

  在基本功能介绍中就不放出原理图了。矩阵键盘可以输入：

- 0~9 10个阿拉伯数字
- A~Z大小写输出
- 大写锁开关（CAP）
- 空格（SPACE）
- 退格（DEL）
- 发送 或是 确定输入密码（ENTER）
- 大写锁开启后，部分数字将变为符号输入（比如0~4）

<span id="wechatBuzzer">

##### 1.1.4 蜂鸣器与数码管

​		蜂鸣器在三种情况下会发出声音：

- 在锁屏界面（密码输入）中，密码的错误输入将存在提示音（音调从高到低，给人一种“沮丧感”）

- 在锁屏界面中，密码输入正确将存在提示音（音调较为欢快）

- 在消息收发界面中，当对方发送消息被我方接收后会有提示音（模拟手机的消息提示音）

  数码管（BCD码四引脚）接在从机上，作用是：<u>从机发送消息进行计数。由于只使用一个BCD数码管，最多计数10次，次数更高将会变为0，从新开始计数</u>

</span>

---

#### 二、硬件实现

##### 1.2.1 串口收发

​		![](C:\Users\15300\Desktop\数电实验\电子线路设计\rtx.JPG)

​		如上图所示，左边的单片机为“从机”，右边的单片机为“主机”（**主机需要连接显示屏进行输出，并且多了密码以及蜂鸣器功能**）。由于我们只需要实现从机到主机的消息发送，故<b><font face="微软雅黑">从机P3.0 RXD</font></b>将不连接<b><font face="微软雅黑">主机P3.1 TXD</font></b>（主机没有消息发送需求）。而为了简化软件编程，使主机不需要软件判定是否存在消息，我们使用<b><font face="微软雅黑">从机P3.2 ${\overline {INT0}}$连接到主机对应端口</font></b>，当从机发送消息时，主机${\overline {INT0}}$将会收到一个低脉冲，引起下降沿中断触发，导致主机中断进入消息接收状态。

​		使用串口的目的就是为了节省AT89C55的引脚，用以实现其他的功能。

##### 1.2.2 矩阵键盘“片选”复用

![](C:\Users\15300\Desktop\数电实验\电子线路设计\key.JPG)

​		在<b><font face="微软雅黑">串口收发（上一小节）</font></b>中可以看到我们使用了两个<b><font face="微软雅黑">74HC573</font></b>（锁存器），使用锁存器为了进行键盘的复用。对锁存器的使能端进行片选操作，可以使用一个拨位开关选择。当某个锁存器接收到高电平时，响应锁存器进入高阻态，对应的单片机也就失去了对键盘的控制。

​		键盘的实现：使用AT89C55的P0口引出8根线进行扫描，有由上图所示，每一列将受到P0口的一个引脚控制，进行键盘扫描。键盘大小为5*8。而行输出介入到P2的低五位。<b><font face="微软雅黑">主机与从机的P0口引出的键盘控制线是相连的</font></b>，于是产生了一个问题：`当前是哪个单片机正在进行控制键盘扫描？`<b><font face="微软雅黑">我使用了单片机的P3.4口进行控制</font></b>，当锁存器片选低使能时，对应的T0输入高电平，表示此时可以让本单片机输出扫描信号。<b><font face="微软雅黑">对应地，另一个单片机将不输出键盘扫描信号以避免电平冲突</font></b>



##### 1.2.3 LM044L显示器模块

​		经典20*4 的显示屏，属于较大，较为难以编写单片机控制程序的显示屏。其上接入另一个可以调节对比度（仿真的时候无效，现实可能有效）的滑动变阻器以及上拉电阻，其余的内容实际上和硬件实现没有关系了，主要是软件实现。

##### 1.2.4 蜂鸣器与数码管电路

​		蜂鸣器电路：<b><font face="微软雅黑">连接在主机的P3.4口进行输出</font></b>，限流电阻为500Ω，使用NPN进行信号放大，输出到(SOUNDER)上进行输出。主要功能就是各类**提示/警示**音。

​		数码管电路：由于存在4个完整引脚的单片机只有从机了，我们要实现一个BCD码数码管的输出，最方便的接入点就是<b><font face="微软雅黑">从机P1端口（全部未使用）</font></b>。按照低位接低位的顺序，可以正常输出。

##### 1.2.5 其他电路

<img src="C:\Users\15300\Desktop\数电实验\电子线路设计\others.JPG" style="zoom:80%;" />

​		存在一个拨位开关（单刀双掷），用于选择主机从机当前<b><font face="微软雅黑">哪一个单片机对键盘进行控制</font></b>，旁边接入了一个LED，用于指示：当从机进行工作，控制键盘时，提示操作者当前是从机控制（LED亮起）

---

#### 三、软件模块

由于我们使用了两个单片机，为了方便，我直接开了两个Keil C51工程进行编辑，所以存在两份工程说明

##### 1.3.1（从/主机）消息发送/接收模块(serial_talk)(serial_listen)

​		本模块对应了`serial_talk.c/serial_talk.h`以及`serial_listen.c / serial_listen.h`

​		serial_talk / serial_listen模块主要实现了串口消息的发送以及接收，其中主要设计到如下内容:

| 单片机寄存器（或特殊位） | 作用                                       |
| ------------------------ | ------------------------------------------ |
| SBUF                     | 串口消息发送接收时需要通过此寄存器进行存取 |
| EX0/EA                   | 外部中断以及总中断                         |
| TR0/TH/TL                | 定时器模块，与波特率的设置直接相关         |
| REN PCON SCON            | 串口通信的相关寄存器                       |

​		使用定时器实现波特率设定后（此处就不讲原理了，就是一个简单的时钟周期计算问题），进行收发。收发都存在需要注意的地方，就是RI / TI的等待：<b><font face="微软雅黑">很可能出现收发事件不一致的情况，或是接收需要话费很多个指令周期，需要使用自旋锁等待</font></b>。



##### 1.3.2 （从机）键盘事件模块(keyboard_module)

​		本模块对应了`keyboard_module.h / keyboard_module.c`

​		功能相对比较单一，主要实现了键盘的扫描输出（1. 扫描输出 2.按键延迟度过不稳定区 3. 长摁情况的忽略）。并且定义了一系列键盘事件 / 键盘映射到ASCII码，主要与显示模块(display_module)进行配合。

##### 1.3.3（主机）显示模块(display_module) （多功能）

​		本模块对应了`display_module.h / display_module.c`

​		模块实现的主要函数：

```c
void Init();				// 初始化

/// ================== 七个按键函数 =====================
void doPop();				// 行尾删除
void allClear();			// 清空(本行)
void confirm();				// 消息发送(或者密码输入)

/// @brief 键盘输入，光标跟随移动，正确的跨行光标显示
void writeCursor(uchar _data);

/// @brief 基本写入功能，data_flag = 0 写入指令，否则写入内容
void write(uchar _dat, bit data_flag);

/// @brief 写入一整列
/// @param align 对齐方式：左边（LEFT），居中（CENTRAL），右边（RIGHT）
void writeLine(uchar* ptr, uint line, bit clear, uchar align);

/// @brief 设置光标位置
void setCursor(uchar row, uchar col);
uchar checkBusy();			// 查询当前显示屏是否处于忙状态

void drawSuspend();			// 绘制密码输入界面
void drawIncomingMessage(uchar *buf, bit self);	// 绘制从 从机而来的消息（更新显示屏）
void printPassword(uchar pin);	// 密码输入替换为‘*’
void isPasswordRight();			// 判定密码输入是否正确，并播放对应的蜂鸣器音乐
void halfBeat(uchar t);			// 蜂鸣器模块输出一个半拍的定时时间
void melody(uchar time);		// 输出蜂鸣器事件
void playSound(uchar* song);	// 播放一整段音乐
```

​		可以看出模块的复杂性，并且考虑到编写者的使用方便，光是“显示在LCD屏上”就存在很多输出方式（比如如何对齐，是否清除其他内容）。使用类似于`writeLine`这样的函数可以非常方便地进行输出格式的调整。

​		软件模块划分较为有条理。使用Javadoc注释风格（比如@brief这种用法）。

##### 1.3.4 其他模块

​		本模块指：`utils.h`以及`utils.c`对应的代码，主要包括如下内容:

- ROM保存的不可变字符串内容

- ROM保存的音阶码

- delay函数以及字长统计函数

- 多个模块共同使用的标识位定义

  本模块头文件将被所有模块引用。

---

## II. 设计二 多功能计算器

---

#### 一、组合功能介绍

##### 2.1.0 框架与流程图

![](C:\Users\15300\Desktop\数电实验\电子线路设计\calc.png)

<center>多功能计算器鱼骨框架图</center>

![](C:\Users\15300\Desktop\数电实验\电子线路设计\flow.png)

<center>使用流程图</center>

##### 2.1.1 自动挂起以及开机挂起

​		仿真开始时，不会直接进入计算机主功能，进入挂起省电模式。此模式下，在进行显示输出之后，单片机进入循环监听键盘事件的状态。监听到“AC”键被按下将会自动退出挂起，进入计算模式。

​												<img src="C:\Users\15300\Desktop\数电实验\电子线路设计\sus.JPG" style="zoom: 50%;" />

​		设置挂起模式的目的是：1. 可以使开机过程存在一个缓冲。当我们不能简单地把仿真开始当成开机时，可以认为从挂起模式唤醒的过程就是一个模拟开机的过程。2. 在计算器长时间不用，使用者忘记关机时，可以使用自动挂起功能。<b><font face="微软雅黑">挂起模式其实可以优化，出于时间与精力上的考虑没有进行，思路如下：</font></b>使单片机进入**掉电模式**，此模式下CPU/定时器/串口全不工作，可以最大程度地减小功耗。在掉电模式下唯一可以唤醒的方式就是外部中断。这种实现也符合我们的按键唤醒模式。

##### 2.1.2 支持+/-/${\times}$/${\div}$ 以及括号运算的计算

​		计算机的主要模式。我觉得如果计算器只能像普通数码管计算器那样，只能单行输入，并且不存在括号对优先顺序的更改，不支持长表达式输出的话，<font size=5> 必然非常<b>low</b></font>。所以==**本计算器支持**==：

- <u>多行输入，使用数据缓冲区保存</u>

- <u>在确定计算之前可以行尾删除，行内修改</u>（PREV/NEXT移动光标到指定位置修改）

- <u>括号运算，长表达式输入，输出表达式最终结果</u>

  计算器主要功能其实并不复杂，但在其实现并不复杂，<b><font face="微软雅黑">参见以下PDF内部跳转链接：</font></b>

  - [**2.3.3 栈模块（计算功能）（stack_module）**](#stackmodule)
  - [<u>**III. 实现过程中遇到的主要问题**</u>](#majorproblem)

##### 2.1.3 菜单/设置界面

​		

| <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\set.JPG" style="zoom:50%;" /> | <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\menu.JPG" style="zoom:50%;" /> |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                           设置界面                           |                           菜单界面                           |

​		设置界面和菜单界面的操控：

- 使用PREV/NEXT按键进行循环切换选项
- 使用“=”按钮进行【模式选择】（菜单）或者【切换ON/OFF设置】（设置）

​		两个界面在键盘上存在单独的按键进行选择切换。点击后会出现对应界面。光标所指的选项为当前正要设置或是正要进入的选项（显然）。存在多个可选模式/设置

| 模式名称        | 作用                                | 设置名称    | 作用                 |
| --------------- | ----------------------------------- | ----------- | -------------------- |
| (Calculation)   | 计算模式，计算器的主要模式          | 45s Suspend | 45s自动挂起开关      |
| (Sensor)        | 传感器模式，可以读取DS18B20温度读数 | Press Sound | 键盘按下是否有提示音 |
| (Alarm Setting) | 闹钟设置                            | LED Light   | 键盘按下是否有指示灯 |

##### 2.1.4 温度显示

| <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\hot.JPG" style="zoom:50%;" /> | <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\cold.JPG" style="zoom:50%;" /> |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|           摄氏度显示：31℃ 描述（Damn Hot）（贼热）           |           华氏度显示：37℉ 描述（Freezing）（冻死）           |

​		显示从DS18B20读取来的温度数据，但注意，不是实时更新的。假如此时我们在DS18B20端改变了输出温度的数值，显示屏不会更新（限制刷新率），需要按下按键，通过键盘事件推动显示更新。

​		使用【PREV/NEXT】按键可以切换摄氏度/华氏度显示，在第三行同时存在对本段温度的描述。

##### 2.1.5 闹钟设置

| <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\no.JPG" style="zoom:50%;" /> | <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\alarm.JPG" style="zoom:50%;" /> |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                  闹钟没有设置的计算界面显示                  |               闹钟设置界面（当前正在设置[分]）               |
| <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\yes.JPG" style="zoom:50%;" /> | <img src="C:\Users\15300\Desktop\数电实验\电子线路设计\on.JPG" style="zoom:50%;" /> |
|                   闹钟设置后的计算界面显示                   |          闹钟响了（播放我最喜欢的歌曲 So Far Away）          |

​		闹钟通过键盘进行设置，可以切换【分钟/秒钟】的时间（以更加快速地设置更长的闹钟时间）。而由于显示屏横向长度的限制，加入小时数设计将不太合适（太长了，在一行内不能显示完闹钟设置项，产生不连贯性），故闹钟最大时常为59min59s。

​		而闹钟是否设置，会在计算模式的顶部栏进行显示（如左边两个图显示的结果）。闹钟时间到后，将会播放闹钟音乐并且自动将顶部状态栏设置回到原来【No Alarm】的情况。

​		本功能还遗留一个没有解决的问题，见[**<u>III. 实现过程中遇到的主要问题</u>**](#majorproblem)

---

#### 二、硬件实现

##### 2.2.1 AT89C55

​		本实验在开始时就选择使用AT系列中，内存最大的一块单片机AT89C55（事实证明还是不太够用，见[**<u>III. 实现过程中遇到的主要问题</u>**](#majorproblem)）。

​		使用本单片机进行实现的好处主要有：

- 电路引脚简单，寄存器的使用相对易于学习

- 内存空间大，适合做规模较大的单片机开发。

  本实验AT89C55个输出端口的连线情况如下：

  <table>
      <tr>
          <td><b>实际电路</b></td>
          <td><b>引脚及其功能</b></td>
      </tr>
      <tr>
          <td rowspan="4"><img src="C:\Users\15300\Desktop\数电实验\电子线路设计\at.JPG" style="zoom:50%;" /></td>
          <td>P0:外接上拉，连接LCD显示屏</td>
      </tr>
      <tr>
          <td>P1:键盘扫描接收端</td>
      </tr>
      <tr>
          <td>P2：部分连接LCD控制线，部分为键盘扫描</td>
      </tr>
      <tr>
          <td>P3：部分为键盘扫描，P3.7为DS18B20传感器读写端</td>
      </tr>
  </table>

##### 2.2.2 LM044L显示器模块

##### 2.2.3 矩阵键盘模块

##### 2.2.4 DS18B20温度传感器

##### 2.2.5 蜂鸣器以及LED

---

#### 三、软件模块

##### 2.3.1 显示模块（display_module）

##### 2.3.2 键盘响应模块（keyboard_module）

<span id="stackmodule">

##### 2.3.3 栈模块（计算功能）（stack_module）

</span>

##### 2.3.4 传感器模块（sensor_module）

##### 2.3.5 附加模块（append_module）

---

### III. 实现过程中遇到的主要问题

<span id="majorproblem">

</span>

---

### IV. 参考文献

---

### V. 附录（体量巨大）

---

#### 5.1 设计一 

##### 5.1.1 开源说明

##### 5.1.2 原理图

##### 5.1.3 代码

---

#### 5.2 设计二

##### 5.2.1 开源说明

##### 5.2.2 原理图

##### 5.2.3 代码

